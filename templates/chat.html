<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { margin: 0; padding-bottom: 3rem; font-family: sans-serif; display: flex; height: 100vh; box-sizing: border-box; }
        #sidebar { width: 150px; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; background-color: #f7f7f7; box-sizing: border-box; height: 100%; }
        #sidebar h3 { margin-top: 0; font-size: 1em; }
        #sidebar ul { list-style-type: none; padding: 0; margin: 0; }
        #sidebar ul li { padding: 2px 0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chat-area { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        #messages { list-style-type: none; margin: 0; padding: 1rem; overflow-y: auto; flex-grow: 1; border-bottom: 1px solid #ccc; }
        #messages > li { padding: 0.5rem 1rem; word-wrap: break-word; }
        #messages > li:nth-child(odd) { background: #efefef; }
        #form { background: rgba(0, 0, 0, 0.1); padding: 0.5rem; display: flex; height: 3.5rem; box-sizing: border-box; }
        #input { border: 1px solid #ccc; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin-right: 0.5rem; }
        #input:focus { outline: none; border-color: #999; }
        #form > button { background: #333; border: none; padding: 0 1rem; border-radius: 3px; outline: none; color: #fff; cursor: pointer; }
        #form > button:hover { background: #444; }
        /* Style for status messages */
        .status-message { font-style: italic; color: #666; text-align: center; padding: 0.25rem 1rem; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Online</h3>
        <ul id="user-list"></ul>
    </div>
    <div id="chat-area">
        <ul id="messages"></ul>
        <form id="form" action="">
            <input id="input" autocomplete="off" placeholder="Type message..." /><button>Send</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> <script>
        // No longer need to get nickname from template/sessionStorage on client side
        // Server knows user identity via Flask-Login session

        const socket = io(location.origin);
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const userList = document.getElementById('user-list');

        // --- Emit Events ---

        // Connect event is handled mostly server-side now for authenticated users
        socket.on('connect', () => {
            console.log('Socket connected to server.');
            // No explicit 'join' needed, server handles on connect if authenticated
        });

        // Send message when form is submitted
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                // Client doesn't strictly NEED to send nickname if server uses current_user,
                // but can be useful for logging or if session handling is complex.
                // Let's keep sending it for now. The server will prioritize current_user.
                socket.emit('new_message', { msg: input.value, nickname: '{{ current_user.username }}' }); // Use Jinja2 to get username IF needed, or remove
                // Simpler: just send msg, server knows sender
                // socket.emit('new_message', { msg: input.value });
                input.value = '';
            }
        });

        // --- Listen for Events ---
        socket.on('chat_message', (data) => {
            // ... (message rendering remains same) ...
             const item = document.createElement('li');
            const safeNickname = data.nickname.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeMsg = data.msg.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            item.innerHTML = `<strong>${safeNickname}:</strong> ${safeMsg}`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('status', (data) => {
            // ... (status rendering remains same) ...
             const item = document.createElement('li');
            item.className = 'status-message';
            const safeMsg = data.msg.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            item.textContent = safeMsg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

         socket.on('user_list_update', (users) => {
            // ... (user list rendering remains same) ...
             userList.innerHTML = '';
            if (users && users.length > 0) {
                users.forEach(user => {
                    const item = document.createElement('li');
                    const safeUser = user.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    item.textContent = safeUser;
                    // Optionally highlight own nickname based on current_user passed if needed
                    // if (safeUser === '{{ current_user.username }}') {
                    //     item.style.fontWeight = 'bold';
                    // }
                    userList.appendChild(item);
                });
            } else {
                const item = document.createElement('li');
                item.textContent = 'No users online';
                item.style.fontStyle = 'italic';
                userList.appendChild(item);
            }
        });

        socket.on('error', (data) => {
            alert(`Server Error: ${data.msg}`);
        });

        socket.on('disconnect', (reason) => {
             // ... (disconnect handling remains same) ...
            console.log('Socket disconnected:', reason);
            const item = document.createElement('li');
            item.className = 'status-message';
            item.textContent = 'You have been disconnected.';
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

    </script>
</body>
</html>