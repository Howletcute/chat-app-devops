<body>
    <script>
        // Get nickname passed from server/sessionStorage
        const nickname = "{{ nickname }}"; // Use nickname passed from Flask template
        sessionStorage.setItem('nickname', nickname); // Store it for potential later use

        const socket = io(location.origin);
        // ... (get elements: messages, form, input, userList) ...

        // --- Emit Events ---
        // **MODIFIED:** Send a 'join' event AFTER connecting
        socket.on('connect', () => {
            console.log('Socket connected, emitting join event.');
            socket.emit('join', { nickname: nickname }); // Send nickname in join event
        });

        // Send message when form is submitted (Include nickname here too)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                // Send nickname with message data
                socket.emit('new_message', { msg: input.value, nickname: nickname });
                input.value = '';
            }
        });

        // --- Listen for Events ---
        // ... (chat_message, status, user_list_update listeners remain the same) ...

         // Optional: Handle errors from server
        socket.on('error', (data) => {
            alert(`Server Error: ${data.msg}`);
            // Maybe redirect or disable input if nickname is taken
        });

    </script>
</body>
</html>